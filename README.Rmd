---
output: github_document
bibliography: detectMatrix.bib
link-citations: yes
always_allow_html: true
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# track2dm : Create detection matrix from transect surveys

<!-- badges: start -->

<!-- badges: end -->

## What is it?

Wildlife scientists often grapple with the question of where a species occurs in the landscape. However, this question is hindered by the fact that most wildlife species cannot be perfectly detected due to various conditions, including weather, landscape characteristics, observer experience, and the species' ecology. As a result, animals may be present at a site but go undetected by the observer (**false absence**), or the species may genuinely be absent (**true absence**). Failing to detect species leads to an underestimation of their true occupancy in study areas. Incorrect estimations of species occurrence can have negative impacts, particularly when occupied habitat is cleared for other purposes.

In 2002, MacKenzie et al. [-@MacKenzie2002] introduced a statistical model capable of estimating the probability of occurrence (known as **psi**) and the probability of detection (known as **p**) to account for the detectability of animals. Detectability can be estimated through repeated observations at each unit/site [@Bailey2005]. These observations can take the form of temporal or spatial replications. *Temporal replications* involve visiting a number of sites (units) multiple times, while *spatial replications* entail dividing survey efforts into several equal parts. For example, in a sampling unit observed using a 5 km transect, each kilometer serves as a replicate, resulting in five replicates for that sampling unit. 

Transect-based methods are commonly used in wildlife surveys to determine the presence or absence of animals in a study area. Typically, transects are randomly selected, and species are observed along the tracks. The length of the transects should be sufficient to calculate both the detection and occurrence of the species. In this type of study, it is advisable to divide the transects into equal lengths, with each length serving as a replicate. However, splitting the transects into equal lengths can be tedious, especially when incorporating altitudinal differences to avoid bias in measuring survey efforts. Currently, there are no applications that provide tools for this purpose, except for ones that split lines into equal areas in ArcGIS or other GIS software.

To bridge the knowledge gap, we have developed a specialized R package called track2dm. Its primary objective is to facilitate the creation of a detection matrix from transect lines, taking into account latitudinal differences. The aim of this document is to provide a practical introduction to the functionality of the track2dm package, demonstrating how it effectively converts field survey data into a detection matrix that is specifically tailored for hierarchical occupancy modeling.

## How to install?

You can install the released version of track2dm and the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("ilubis85/track2dm")
```

## How does it work?

Within the track2dm package, we have included pre-loaded data for simulation purposes. To effectively demonstrate the package's functionality, two types of data are required: the observation data, which captures species occurrences along the track and is usually formatted in Excel; and the digital elevation model (DEM) data, provided in raster format. Once the package is called, these data can be easily loaded for further analysis and utilization.

```{r example}
# LOAD ALL DATA
# Read elevation raster data from the package
data("dem")

# Read the observation from the package
data("occu_survey")

```

In this particular example, the survey data is stored as a data frame and consists of information such as the date, time, X and Y coordinates, and any relevant information related to the observed species, which are typically obtained from a GPS device. It is important to note that elevation data is necessary to extract Z values, allowing for the calculation of distances in three dimensions (3D) during the analysis process.

```{r track}
head(occu_survey, 5)
```

*Acknowledgment*: The data used in this package is derived from a real survey but has been modified for practical purposes. We would like to acknowledge the original source of the data and express gratitude for their permission to use and modify it for the development and demonstration of this package.

The track2dm package offers several key functions that greatly simplify the generation of a detection matrix for a species. In this tutorial, we will primarily utilize the following functions:

```{r echo=FALSE}
functions <- c("dist3D()", "speciesDM()", "makeGrids()", "sliceGrids()", "speciesDM_grid()", "line2points()", "copyID()", "dm2spatial")

purposes <- c("Calculate distance based on X, Y, and Z information from a dataframe",
              "Extract detection matrix from the species observation",
              "Create grid cells (fishnet) from a given spatial data",
              "Split grid cells into smaller grid cells",
              "Extract detection matrix from the species observation over a grid cells",
              "Convert SpatialLinesDataframe into SpatialPointsDataframe",
              "Copy attributes from other spatial points data-frame",
              "Convert detection matrix into spatial data")

r_functions <- data.frame(functions, purposes)
colnames(r_functions) <- c("Function", "Purpose")
```

```{r tab_1, caption = "test", echo=FALSE}
library(knitr)
library(kableExtra)
r_functions %>% 
  kbl() %>% 
  kable_styling()
```
In this tutorial, our main objective is to create a detection matrix using the observation transect lines data obtained from surveys. In some cases, if the track lines are missing or not available, we have the option to re-digitize them using GIS software. This enables us to create accurate detection matrices based on the newly digitized track lines. We will address this process in more detail later on in the tutorial, providing guidance on how to handle such scenarios effectively.

## 1. Create detection matrix from a single transect line

To create a detection matrix from a single transect line, you can use the track2dm package. First, calculate the distances between points along the transect line while considering latitudinal differences using the **dist3D()** function. Then, divide the line into segments of a predefined length. Finally, convert the segmented line into a detection matrix using the **speciesDM()** function, which assigns presence (1) or absence (0) values to each unit based on observed species data.

```{r , message=FALSE}

# Load library
library(tidyverse)

# Check the species list
occu_survey$Species %>% table() # We will create a DM from deer (Rusa Unicolor - RUU)

# Calculate distances 
occu_dist <- track2dm::dist3D(dataFrame = occu_survey, Xcol = "X", Ycol = "Y", elevData = dem, repLength = 2000)

# Create detection matrix
ruu_dm <- track2dm::speciesDM(speciesDF = occu_dist, sortID = "DateTime", Xcol = "X", Ycol = "Y", whichCol = "Species", whichSp = "RUU", samplingCov = "Habitat", samplingFun = track2dm::modal)

# Check the detection matrix
head(ruu_dm, 5)

```

Using a 2 km length of replicates, a total of 24 replicates were generated, indicating the presence (1) or absence (0) of deer species. The provided codes also generated survey covariates, such as the habitat (FOR for forest) where the observations occurred. The X and Y coordinates can be utilized to create a visual representation of the detection matrix for review purposes. This can be achieved by converting the detection matrix into a spatial points dataframe using the **dm2spatial()** function. The resulting dataframe can then be plotted on a map using the *tmap package*, allowing for a spatial visualization of the deer species distribution.

```{r fig_1, out.width='75%', fig.align='left',  fig.pos="H", fig.cap="Points depicting presence (black dots) and absence (red dots) of deer using 1000 mtr replicate length)", collapse = TRUE, echo = FALSE}
# Convert to spatial dataframe
# Specify the data projection using the same projection from elevation data
ruu_dm_sp <- track2dm::dm2spatial(detectMatrix = ruu_dm, proJect = raster::crs(dem))

# Visualize the detection matrix
library(tmap)
tm_shape(dem) +
  tm_raster(style = "cont", palette = terrain.colors(8)) +
  tm_shape(ruu_dm_sp) + tm_dots(col = 'Detection', palette = c("red", "black"), shape=18, size=0.5)+
  tm_layout(legend.outside = TRUE)
```
## 2. Create detection matrix from multiple transect line

In this example, the detection matrix for deer represents observations from a single unit sample. However, in real studies, the study area is typically divided into grid cells of equal size. To simulate this, the survey area will be divided into multiple grid cells by creating grid cells using the **makeGrids()** function in the next part of the tutorial. The detection matrix for the selected species will then be created from all the grid cells simultaneously using the **speciesDM_grids()** function. To use the speciesDM_grids() function, spatial data for observations, elevation data, and the grid cell polygons are required as inputs. This approach enables the generation of a comprehensive detection matrix for the selected species across the entire set of grid cells in the study area, allowing for more robust occupancy modeling.

```{r , message=FALSE}

# Create a grid cell over the study area
grid_5km <- track2dm::makeGrids(spObject = dem, cellSize = 5000)

# Convert observation data into spatial data
occu_survey_sp <- sp::SpatialPointsDataFrame(coords = occu_survey[,c("X", "Y")], data = occu_survey, proj4string = raster::crs(dem))

# Create detection matrix directly for RUU
ruu_grids_dm <- track2dm::speciesDM_grid(spData = occu_survey_sp, repLength = 1000, gridCell = grid_5km, subgridCol = "id", elevData = dem, sortID = "DateTime", Xcol = "X", Ycol = "Y", whichCol = "Species", whichSp = "RUU", samplingCov = "Habitat", samplingFun = track2dm::modal)

# Check the detection matrix
head(ruu_grids_dm, 5)

```
We can then visualise the detection matrix from each grid cell similar to previous plot.

```{r fig_2, out.width='75%', fig.align='left',  fig.pos="H", fig.cap="Points depicting presence (black dots) and absence (red dots) of deer form each grid cell)", collapse = TRUE, echo = FALSE}
# Convert to spatial dataframe
# Specify the data projection using the same projection from elevation data
ruu_dm_grid_sp <- track2dm::dm2spatial(detectMatrix = ruu_grids_dm, proJect = raster::crs(dem))

# Visualize the detection matrix
library(tmap)
tm_shape(dem) +
  tm_raster(style = "cont", palette = terrain.colors(8)) +
  tm_shape(grid_5km) + tm_borders(lty=2)+
  tm_shape(ruu_dm_grid_sp) + tm_dots(col = 'Detection', palette = c("red", "black"), shape=18, size=0.5)+
  tm_layout(legend.outside = TRUE)
```
Figure 2 above displays the detection matrix obtained from seven 5km grid cells where the surveys were conducted. The matrix consists of seven rows representing observations from each grid cell, with a maximum of eight replicates (R8) for each observation. This detection matrix serves as a valuable input for occupancy modeling, enabling further analysis and interpretation of the species' occurrence patterns and habitat preferences within the surveyed grid cells.

The detection matrix can be saved as a dataframe using the **write.csv()** function, allowing for easy data storage and further analysis. Alternatively, for review purposes and spatial analysis, the detection matrix can be saved as a spatial dataframe using the **writeOGR()** function or other similar functions commonly used for spatial data storage. These approaches provide flexibility in saving the detection matrix in different formats based on the specific requirements of the analysis or subsequent processing steps.

**Next, how to create detection matrix from patrol data that does not have tracklines?**

### References
